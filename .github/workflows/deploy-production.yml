name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.event.inputs.version }}

      - name: Verify staging tests passed
        run: |
          echo "Verifying staging environment is healthy..."
          # Add staging health check here

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: abstractfinance
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            cd /srv/abstractfinance

            # Create backup
            docker compose exec -T postgres pg_dump -U postgres abstractfinance > /backups/pre_deploy_$(date +%Y%m%d_%H%M%S).sql

            # Pull and tag the release
            git fetch --tags
            git checkout ${{ github.event.release.tag_name || github.event.inputs.version }}

            # Pull pinned Docker images
            docker compose pull

            # Rebuild and restart with zero-downtime (including cross-monitor)
            docker compose -f docker-compose.yml -f docker-compose.prod.yml build trading-engine cross-monitor
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps trading-engine cross-monitor

            # Wait for IBGA headless 2FA login
            sleep 120

            # Verify services are running
            docker compose ps
            docker compose logs --tail=100 trading-engine

            # Verify IB connection (IBGA uses port 4000)
            docker compose exec -T trading-engine python -c "
            from ib_insync import IB
            ib = IB()
            ib.connect('ibgateway', 4000, clientId=99, timeout=30)
            assert ib.isConnected(), 'Failed to connect to IB Gateway'
            print('IB Gateway connection verified')
            ib.disconnect()
            "

      - name: Notify deployment success
        if: success()
        run: |
          echo "Successfully deployed ${{ github.event.release.tag_name || github.event.inputs.version }} to production"

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: abstractfinance
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            cd /srv/abstractfinance
            git checkout main
            docker compose up -d
            echo "Rolled back to main branch"
