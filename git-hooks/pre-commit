#!/bin/bash
# Pre-commit hook to detect potential secrets in staged files
# Part of AbstractFinance security hardening
#
# Install with: ./scripts/install-hooks.sh
# Or manually: cp git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running secret detection pre-commit hook..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

SECRETS_FOUND=0

# Patterns that indicate potential secrets
SECRET_PATTERNS=(
    # API keys and tokens - detect non-op:// values
    'IBKR_PASSWORD\s*=\s*[^op://]'
    'IBKR_TOTP_KEY\s*=\s*[^op://]'
    'password\s*=\s*["\x27][A-Za-z0-9!@#$%^&*]{8,}["\x27]'
    'token\s*=\s*["\x27][A-Za-z0-9_-]{20,}["\x27]'
    'api_key\s*=\s*["\x27][A-Za-z0-9_-]{20,}["\x27]'
    'secret\s*=\s*["\x27][A-Za-z0-9_-]{20,}["\x27]'
    # AWS patterns
    'AKIA[0-9A-Z]{16}'
    # Private keys
    '-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----'
    # Service account tokens
    'OP_SERVICE_ACCOUNT_TOKEN\s*=\s*[^<]'
)

# Check each staged file
for FILE in $STAGED_FILES; do
    # Skip binary files and specific paths
    if [[ "$FILE" == *.png ]] || [[ "$FILE" == *.jpg ]] || [[ "$FILE" == *.gif ]]; then
        continue
    fi

    # Skip the hook itself
    if [[ "$FILE" == *"pre-commit"* ]]; then
        continue
    fi

    # Check if file exists (might be deleted)
    if [ ! -f "$FILE" ]; then
        continue
    fi

    for PATTERN in "${SECRET_PATTERNS[@]}"; do
        if git diff --cached "$FILE" | grep -qE "$PATTERN" 2>/dev/null; then
            echo -e "${RED}POTENTIAL SECRET DETECTED${NC} in $FILE"
            echo -e "${YELLOW}Pattern: $PATTERN${NC}"
            SECRETS_FOUND=1
        fi
    done
done

# Check for .env files being committed (should never happen)
for FILE in $STAGED_FILES; do
    if [[ "$FILE" == ".env" ]] || [[ "$FILE" == *.env ]] && [[ "$FILE" != ".env.template" ]] && [[ "$FILE" != "*.env.template" ]]; then
        echo -e "${RED}ERROR: Attempting to commit .env file: $FILE${NC}"
        echo "Use .env.template with op:// references instead!"
        SECRETS_FOUND=1
    fi
done

if [ $SECRETS_FOUND -eq 1 ]; then
    echo ""
    echo -e "${RED}Commit blocked due to potential secrets.${NC}"
    echo "If this is a false positive, you can bypass with: git commit --no-verify"
    echo "But please review carefully first!"
    exit 1
fi

echo "Secret detection passed."
exit 0
